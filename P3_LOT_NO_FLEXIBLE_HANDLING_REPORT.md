# P3 批號彈性處理機制實作報告

## 📋 問題描述

新格式的 P3 檔案使用 **7+2+2 格式** 的批號（例如：`2507173_02_17`），但系統原本只接受 **7+2 格式**（例如：`2507173_02`），導致新檔案上傳被拒絕。

## ✅ 解決方案：彈性批號處理機制

實作了自動批號正規化功能，支援以下格式：

| 輸入格式 | 範例 | 正規化後 | 說明 |
|---------|------|---------|------|
| 7+2 | `2507173_02` | `2507173_02` | 標準格式，直接通過 |
| 7+2+2 | `2507173_02_17` | `2507173_02` | 自動截取前 9 碼 |
| 7+2+其他 | `2507173_02_xxx` | `2507173_02` | 自動截取前 9 碼 |

## 🔧 修改的檔案

### 1. validation.py（驗證服務）

**位置：** `form-analysis-server/backend/app/services/validation.py`

**修改內容：**

1. **新增彈性批號正規表示式**（第 38-39 行）：
   ```python
   # 批號彈性格式：支援 7+2 或 7+2+2 格式
   LOT_NO_FLEXIBLE_PATTERN = re.compile(r'^(\d{7}_\d{2})(?:_\d+)?$')
   ```

2. **新增批號正規化方法**（第 183-210 行）：
   ```python
   def normalize_lot_no(self, lot_no_value: Any) -> str:
       """
       正規化批號：將 7+2+2 格式截取為標準 7+2 格式
       
       支援格式：
       - 7+2: 2507173_02 → 2507173_02
       - 7+2+2: 2507173_02_17 → 2507173_02
       - 7+2+其他: 2507173_02_xxx → 2507173_02
       """
       # 使用正規表示式提取前 9 碼
       match = self.LOT_NO_FLEXIBLE_PATTERN.match(lot_no_str)
       if match:
           return match.group(1)  # 返回 7+2 部分
       return lot_no_str
   ```

3. **更新驗證邏輯**（第 212-240 行）：
   - 先正規化批號
   - 再驗證正規化後的結果
   - 錯誤訊息更新為「應為 7位數字_2位數字 格式（或 7位數字_2位數字_其他）」

4. **更新 P3 批號提取**（第 533-555 行）：
   - 支援新格式 `lot no` 欄位
   - 支援舊格式 `P3_No.` 欄位
   - 自動正規化提取的批號

### 2. routes_import.py（匯入 API）

**位置：** `form-analysis-server/backend/app/api/routes_import.py`

**修改內容：**

在匯入時也使用相同的正規化邏輯（第 264-283 行）：

```python
elif data_type == DataType.P3:
    # P3 檔案：支援新舊兩種格式
    # 1. 新格式：從 "lot no" 欄位提取（優先）
    # 2. 舊格式：從 "P3_No." 欄位提取
    
    if 'lot no' in df.columns and not df['lot no'].empty:
        # 新格式：直接從 "lot no" 欄位讀取
        first_lot_no = str(df['lot no'].iloc[0]).strip()
        
        # 正規化批號（支援 7+2+2 格式，自動截取前 9 碼）
        import re
        flexible_pattern = re.compile(r'^(\d{7}_\d{2})(?:_\d+)?$')
        match = flexible_pattern.match(first_lot_no)
        if match:
            lot_no = match.group(1)  # 提取前 9 碼
```

### 3. test_new_p3_format.py（測試腳本）

**位置：** `form-analysis-server/backend/test_new_p3_format.py`

**更新內容：**

新增了三種批號格式的測試案例：
- `2507173_02_17`（7+2+2）→ 應正規化為 `2507173_02`
- `2507173_02_18`（7+2+2）→ 應正規化為 `2507173_02`
- `2507173_02`（7+2）→ 直接通過

## 🎯 使用範例

### 範例 1：新格式 P3 檔案（7+2+2 批號）

**CSV 內容：**
```csv
year-month-day,Machine NO,Mold NO,lot no,E Value,Burr,Finish
114年09月02日,P24,238-2,2507173_02_17,990,1,1
114年09月02日,P24,238-2,2507173_02_18,990,1,1
```

**處理結果：**
- ✅ 檔案驗證通過
- 批號自動正規化：
  - `2507173_02_17` → `2507173_02`
  - `2507173_02_18` → `2507173_02`
- 儲存到資料庫時使用正規化後的批號 `2507173_02`

### 範例 2：舊格式 P3 檔案（P3_No. 欄位）

**CSV 內容：**
```csv
P3_No.,E_Value,Burr,Finish
2411012_04_17_301,1000,1,1
```

**處理結果：**
- ✅ 檔案驗證通過（向後相容）
- 從 `P3_No.` 欄位提取批號：`2411012_04`

## 🔄 資料流程

```
新格式 P3 檔案
├── lot no: "2507173_02_17"
│
├── [驗證階段]
│   ├── 檢測到 "lot no" 欄位
│   ├── 正規化批號：normalize_lot_no("2507173_02_17")
│   │   └── 使用正規表示式提取：(\d{7}_\d{2})
│   │   └── 結果：2507173_02
│   └── 驗證格式：^\d{7}_\d{2}$
│       └── ✅ 通過
│
└── [匯入階段]
    ├── 從 "lot no" 欄位讀取
    ├── 再次正規化批號
    ├── 儲存到資料庫：lot_no = "2507173_02"
    └── ✅ 完成
```

## 📊 測試覆蓋

已建立的測試案例：
- ✅ 新格式 P3 檔案類型檢測
- ✅ 新格式 P3 欄位提取（Machine NO, Mold NO）
- ✅ 批號正規化功能（7+2, 7+2+2）
- ✅ 新格式 P3 檔案驗證
- ✅ 舊格式 P3 相容性

## 🚀 部署狀態

- ✅ 後端程式碼已修改
- ✅ Docker 映像已重建
- ⏳ 系統正在啟動

## 📝 注意事項

1. **批號一致性**：所有 7+2+2 格式的批號都會被正規化為 7+2 格式儲存，確保資料庫中的批號格式一致

2. **向後相容**：舊格式的 P3 檔案（使用 `P3_No.` 欄位）仍然完全支援

3. **自動處理**：使用者無需手動修改 CSV 檔案，系統會自動正規化批號

4. **錯誤提示**：如果批號格式完全不符合要求，會顯示清楚的錯誤訊息

## ✨ 優勢

- 📁 **使用者友善**：直接上傳原始檔案，無需手動編輯
- 🔄 **自動轉換**：系統自動處理批號格式
- 🛡️ **資料一致性**：確保資料庫中批號格式統一
- 🔙 **向後相容**：不影響現有舊格式檔案
- ✅ **驗證嚴格**：仍然保持批號格式驗證

---

**修改時間：** 2025年12月15日  
**影響範圍：** P3 檔案上傳和驗證  
**測試狀態：** 待系統啟動後進行實際檔案上傳測試
