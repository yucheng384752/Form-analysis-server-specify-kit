# 批號驗證問題修正報告

## 🔍 問題診斷

**用戶報告：** `2507173_02_17` 無法通過驗證

**根本原因：** 原始的彈性批號正規表示式 `r'^(\d{7}_\d{2})(?:_\d+)?$'` 只能匹配「一個下劃線加數字」，無法處理多段格式如 `2411012_04_31_302`（7+2+2+3 格式）。

## ✅ 解決方案

### 修正正規表示式

**原始版本（有問題）：**
```python
LOT_NO_FLEXIBLE_PATTERN = re.compile(r'^(\d{7}_\d{2})(?:_\d+)?$')
```
- ❌ `(?:_\d+)?` 只能匹配一次「下劃線+數字」
- ❌ 無法處理 `2411012_04_31_302` 這類多段格式

**修正版本（正確）：**
```python
LOT_NO_FLEXIBLE_PATTERN = re.compile(r'^(\d{7}_\d{2})(?:_.+)?$')
```
- ✅ `(?:_.+)?` 可以匹配「下劃線+任意內容」
- ✅ 支援所有 7+2+後續內容的格式

## 📊 測試結果

### 測試案例

| 輸入批號 | 正規化結果 | 驗證結果 | 說明 |
|---------|-----------|---------|------|
| `2507173_02` | `2507173_02` | ✅ 通過 | 標準 7+2 格式 |
| `2507173_02_17` | `2507173_02` | ✅ 通過 | 7+2+2 格式 |
| `2507173_02_18` | `2507173_02` | ✅ 通過 | 7+2+2 格式 |
| `2411012_04` | `2411012_04` | ✅ 通過 | 標準 7+2 格式 |
| `2411012_04_31_302` | `2411012_04` | ✅ 通過 | 7+2+2+3 格式 |
| ` 2507173_02_17 ` | `2507173_02` | ✅ 通過 | 帶空格（自動去除）|
| `250717_02` | `250717_02` | ❌ 失敗 | 錯誤：只有6個數字 |
| `2507173_2` | `2507173_2` | ❌ 失敗 | 錯誤：只有1個數字 |
| `abc_def` | `abc_def` | ❌ 失敗 | 錯誤：非數字 |

## 🔧 修改的檔案

### 1. validation.py

**位置：** `form-analysis-server/backend/app/services/validation.py`

**修改內容：** 第 40 行
```python
# 修改前
LOT_NO_FLEXIBLE_PATTERN = re.compile(r'^(\d{7}_\d{2})(?:_\d+)?$')

# 修改後
LOT_NO_FLEXIBLE_PATTERN = re.compile(r'^(\d{7}_\d{2})(?:_.+)?$')
```

### 2. routes_import.py

**位置：** `form-analysis-server/backend/app/api/routes_import.py`

**修改內容：** 第 273 行
```python
# 修改前
flexible_pattern = re.compile(r'^(\d{7}_\d{2})(?:_\d+)?$')

# 修改後
flexible_pattern = re.compile(r'^(\d{7}_\d{2})(?:_.+)?$')
```

## 🎯 支援的批號格式

現在系統完整支援以下所有格式：

| 格式 | 範例 | 正規化為 | 用途 |
|-----|------|---------|------|
| 7+2 | `2507173_02` | `2507173_02` | 標準批號 |
| 7+2+2 | `2507173_02_17` | `2507173_02` | P3 檔案（新格式）|
| 7+2+2+3 | `2411012_04_31_302` | `2411012_04` | P3_No. 欄位（舊格式）|
| 7+2+任意 | `2507173_02_xxx_yyy` | `2507173_02` | 任意擴展格式 |

## 📝 正規表示式說明

```regex
^(\d{7}_\d{2})(?:_.+)?$
```

**組成部分：**
- `^` - 字串開始
- `(\d{7}_\d{2})` - **捕獲組 1**：7個數字 + 下劃線 + 2個數字（這是我們要提取的批號）
- `(?:_.+)?` - **非捕獲組（可選）**：
  - `_` - 下劃線
  - `.+` - 一個或多個任意字元（包括數字、下劃線等）
  - `?` - 整個非捕獲組是可選的
- `$` - 字串結束

**為什麼使用 `.+` 而不是 `\d+`：**
- `\d+` 只能匹配數字，無法處理多段格式（如 `_17_301`）
- `.+` 可以匹配任意字元，包括下劃線和數字的組合

## 🚀 部署狀態

- ✅ 修正正規表示式
- ✅ 更新兩個檔案（validation.py, routes_import.py）
- ✅ 測試通過（所有格式）
- ✅ Docker 映像已重建
- ⏳ 等待系統啟動以進行實際檔案測試

## 🧪 如何測試

### 測試步驟

1. **啟動系統**
   ```bash
   cd C:\Users\yucheng\Desktop\Form-analysis-server-specify-kit\scripts
   .\start-system.bat
   ```

2. **準備測試 CSV 檔案**
   - 使用您的 `P3_0902_P24 copy.csv` 檔案
   - 確認 `lot no` 欄位包含 `2507173_02_17` 等格式

3. **上傳檔案**
   - 訪問 http://localhost:18003
   - 進入上傳頁面
   - 選擇 P3 CSV 檔案
   - 點擊上傳

4. **驗證結果**
   - ✅ 檔案應該成功通過驗證
   - ✅ 批號應該被正規化為 `2507173_02`
   - ✅ 資料應該成功匯入資料庫

### 預期結果

**驗證階段：**
```
✓ 檔案類型檢測: P3
✓ 欄位驗證: 通過
✓ 批號提取: 2507173_02_17 → 2507173_02
✓ 批號驗證: 通過
```

**匯入階段：**
```
✓ 資料解析: 成功
✓ 批號正規化: 2507173_02
✓ 儲存到資料庫: 成功
```

## 📌 重要提醒

1. **所有批號都會被正規化**：無論輸入是 `2507173_02_17` 還是 `2411012_04_31_302`，最終儲存到資料庫的都是前 9 碼（7+2 格式）

2. **向後相容**：舊格式的 P3 檔案（使用 `P3_No.` 欄位）仍然完全支援

3. **錯誤處理**：如果批號格式完全不正確（如 `250717_02` 或 `abc_def`），仍然會被拒絕並顯示錯誤訊息

---

**修正時間：** 2025年12月15日  
**問題根源：** 正規表示式過於嚴格，無法匹配多段格式  
**解決方案：** 使用 `.+` 替代 `\d+` 以支援任意後續內容  
**測試狀態：** ✅ 單元測試通過，等待實際檔案測試
