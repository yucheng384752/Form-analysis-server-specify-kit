## P0（阻斷/明確錯誤，先修）

- [x] ERROR: 生產追溯流程 -> 流程圖 -> P1 原料卡片 -> P1 資料詳情內的"編輯資料"按鈕 422 **需要移除**（前端先移除入口）
  - 已處理：前端已移除 P1 詳情的 edit 入口（避免觸發後端 422）
- [x] ERROR:表格修正功能未正常運作，需要修正（需先確認是哪個頁面/按鈕/功能）
  - 已修（2026-01-09）：UploadPage 若有未儲存的表格修改，點「重新驗證」會改成先呼叫「儲存修改」（PUT /api/upload/{processId}/content，用目前編輯後的 CSV 重新驗證），避免重新上傳原始檔案導致修正無效的錯覺
  - 同步修正文案：錯誤提示/表格提示改為引導按「儲存修改」（會自動重新驗證）

## P1（資料正確性/查詢可信度）

- [x] FIX:P2 分條時間要對應到生產日期
  - 已修（2026-01-09）：P2 詳細表格顯示改用統一格式化（含民國年轉西元）；若「分條時間」只有 HH:MM(/HH:MM:SS) 會自動補上該筆 record.production_date
- [x] ERROR: product_id解析錯誤
  - 已修：P3 trace/detail 不再回傳 UNKNOWN machine/mold（UNKNOWN 時由 extras.rows[0] 推導回傳）
  - 已修：legacy 匯入 + 修復腳本補齊 p3_items.product_id，並處理 UNIQUE 衝突（必要時加 _dup 後綴）
  - 已修：發現某些 _dup 是因「item 的 production_date 被寫成 record 的日期」造成碰撞，已修正匯入邏輯與既有資料（例：20250902_P21_238-3_301_dup9）
- [x] TODO:新資料庫未進行遷移，檔案內容暫時使用舊的record.p2_items以及record.p3_items[需確認]
  - 已確認（2026-01-09）：前端查詢頁目前呼叫 `/api/query/records`、`/api/query/records/advanced`（legacy 路由），因此明細資料來源仍是 `records` + `record.p2_items` / `record.p3_items`
  - 若要改用 V2 正規化查詢（`/api/v2/query/...`、對應 `p1_records/p2_records/p3_records`），需先跑一次 V1→V2 轉換腳本 `backend/migrate_v1_to_v2_internal.py`（或後續全部走 `import_v2` 寫入 V2 表）

## P2（查詢 UX/呈現與可用性）

- [ ] FIX:修改查詢邏輯: 使用高級查詢時，顯示單筆資料即可，有多筆符合，條列之
- [x] FIX:進階搜尋縮小化
  - 已完成（2026-01-12）：進階搜尋按鈕移入搜尋框區塊內，預設收合，點擊展開
- [x] TODO:需確認是否要加入winder Number條件在進階搜尋
  - 已完成（2026-01-12）：進階搜尋已加入 winder_number 篩選條件，支援 P2/P3 資料查詢
- [x] FUNC:新增進階搜尋檢索欄位
  - [x] winder number（已完成 2026-01-12）
  - [x] P1 規格(specification)對應到 P2 的規格(format) P3規格(specification)
    - 已完成（2026-01-12）：統一規格搜尋，後端支援 P1.Specification, P2.format, P3.Specification
  - [ ] material(p1, p2一樣)
- [x] TODO:確認"進階搜尋"的日期起訖是否可以只找當日日期
  - 已完成（2026-01-12）：若只填寫起始或結束日期之一，自動使用同一天進行單日查詢
- [ ] FIX:p2 前端細項表格修正: 將winder number 代替 "#" 欄位
- [x] TODO:p1, p2, p3 基本資料欄位可以移除不顯示
  - 已完成（2026-01-12）：已移除 P1/P2/P3 的「基本資料」卡片區塊
- [x] FUNC:欄位加入排序功能
  - 已完成（2026-01-12）：P2/P3 細項表格支援點擊表頭排序（升序/降序切換）

## P3（新功能/文件/整理）

- [ ] FUNC:PDF 輸入的流程需要詳細記錄
- [X] TODO:PDFtoCSVserver
  - input: PDF files
  - output: JSON(像是vscode打開csv檔案，只有資料與逗點)
  - PDF file name = CSV file name
- [X] TODO:Dataframe 格式
  - [X] 日期篩選
  - [X] finish 篩選 
- [ ] FUNC:使用簡單加密
- [ ] FILE:撰寫 breakdown 架構圖
- [ ] FILE:撰寫功能表
  - 已實作 source_winder 欄位自動提取邏輯
  - 從 lot_no 最後兩碼提取並儲存到 p3_items.source_winder
  - 支援索引查詢
- [ ] QUES:adjustment record 是否要/有 建立從表?(現在是顯示0, 1 <- 需要詢問是否對應紙本上的A, B, C)
- [ ] TODO:整理冗餘/過時/錯誤資料
- [ ] FUNC:中/英文介面切換
  - 介面文字
  - 表格標題與內文
  - toast 提示文字
  - 放在app-header內，靠右下的地方
  - 設計成切換開關樣式

# 0109 已發現的問題/要修正的地方
- [ ] FIX: P1 lot_no 查詢之前端顯示風格修改 -> 需要提供表格(PDFor圖片)
- [ ] FIX: P1 lot_no 查詢之production date欄位解析錯誤(需確認是否為後端輸入資料庫前的解析問題)
- [x] ERROR: Product_id 解析錯誤，需要修正(20250902_Unknown_1_304)
  - 這類 Unknown 來自 DB 欄位 UNKNOWN + 前端組字串；已在後端回傳層做 fallback（從 extras 推導 machine/mold）+ 既有資料回填
- [x] TODO:確認 P3 資料寫入路徑
  - 已確認（2026-01-09）：
    - V2 匯入（import_v2）會寫入 `p3_records`（app/services/import_v2.py 建立/更新 P3Record）
    - legacy 路徑會寫入 `records` + `p3_items`
    - 生產追溯 API `/api/traceability/product/{product_id}` 會先查 `p3_items`，查不到再 fallback 查 `p3_records`
  - 待確認（保留議題）：前端查詢 P3 明細時要「優先哪一路徑」或「合併顯示」的策略（屬 UX/一致性決策）
- [X] FIX: p2_records表有20筆資料，但是p3_records只有一筆資料，需要修復關聯的關係，以及檢查設定檔


## 0112 待辦事項

- [x] 測試 P1 UT API
  - 已完成（2026-01-12）：修復 SQL 類型轉換問題，使用 func.date() 進行日期比較
  - 測試結果：成功返回 1 筆資料 (2026-01)
- [x] 測試 P1+P2+P3 組合查詢
  - 已完成（2026-01-12）：修復追溯邏輯（P3 → P2Record → P2Item → P1Record）
  - 測試結果：成功返回 16 筆資料，欄位前綴正確
- [x] P1表格顯示錯誤，API未正確取得內容，additional_data是空的
  - 已修復（2026-01-12）：修改 `_p1_to_query_record()` 返回完整 `r.extras` 而非僅第一行
  - Commit: ee2be1d
- [x] 查詢P2會顯示20筆，需要修正
  - 已修復（2026-01-12）：新增 `_merge_p2_records()` 函數將 20 個 winders 合併為單筆記錄
  - 合併後的 additional_data 包含完整 winders 陣列資料
  - Commit: ee2be1d
  - 已完善（2026-01-13）：當進階查詢指定 winder_number 時，只顯示該 winder 的資料；沒有指定時才合併顯示
- [x] product_id產生錯誤，需寫死規定: YYYYMMDD-機台-模號-批號
  - 已修復（2026-01-12）：統一所有產生和解析邏輯使用破折號分隔
  - 修改範圍：ProductIDGenerator, import_v2, routes_import, 所有 migration 腳本
  - Commit: 208a339
  - 已完善（2026-01-13）：Product ID 解析支援底線 '_' 和破折號 '-' 兩種分隔符（向下相容舊資料格式如 20250902_P24_238-2_301）
- [ ] 修正匯入邏輯（確保未來同步寫入 legacy 和 V2）
- [ ] 是否可以修正成records放單筆資料，細項放在items的表內（架構設計議題，需討論）
- [ ] 進階搜尋與查詢按鈕要重新設計(大小相同，寬度與"資料查詢[app-main-tab is-active]"的按鈕相同)
- [ ] 進階查詢要設計展開動畫

## 0113 已完成修復

1. **Product_ID 格式驗證增強**（高優先級）
   - 問題：系統僅接受破折號分隔格式，但實際資料使用底線分隔
   - 解決：修改 `product_id_generator.py` 的 `parse()` 函數，同時支援底線 '_' 和破折號 '-' 分隔符
   - 影響：向下相容舊資料，如 `20250902_P24_238-2_301` 現在可以正確解析
   - 測試：通過 9/9 測試案例（包含複雜情況：模具號碼含破折號、去重後綴等）

2. **P2 進階查詢邏輯優化**（高優先級）
   - 問題：查詢 P2 時顯示 20 筆重複的 lot_no 記錄
   - 解決：
     - 無 winder_number 篩選時：使用 `_merge_p2_records()` 合併 20 個 winders 為單筆顯示
     - 有 winder_number 篩選時：只顯示指定 winder 的單筆資料（不合併）
   - 修改檔案：`routes_query_v2.py` 的 `advanced_search()` 函數
   - 測試：邏輯驗證通過

3. **進階查詢 winder 篩選邏輯**
   - 實作：當進階查詢指定 winder_number 時，只返回匹配的單筆 row 資料
   - 適用範圍：P2、P3（P1 不在此限，總是顯示完整資訊）
   - 效能優化：在 SQL 層級直接篩選 `WHERE winder_number = ?`

4. **Product_ID 解析演算法改進**
   - 問題：破折號格式下，模具號碼本身包含破折號（如 `238-2`）導致分割錯誤
   - 解決：實作智慧解析演算法
     - 自動偵測分隔符（底線優先）
     - 靈活分割：日期(1) - 機台(1) - 模具(1+) - 批號(1) [- 後綴(可選)]
     - 從後向前搜尋第一個整數作為批號，中間所有部分組成模具號碼
     - 自動忽略去重後綴（如 `_dup9`）
   - 測試：所有邊界情況正確處理

5. **測試與文件**
   - 測試腳本：`backend/test_product_id_simple.py`
   - 測試報告：[dev-docs/2025-01/0113-test-report.md](dev-docs/2025-01/0113-test-report.md)
   - 測試結果：9/9 通過 
   - TODO 更新：本文件已更新記錄所有修正

6. **P2 顯示問題修正**（高優先級）
   - 問題：一般查詢時 P1/P3 正常顯示，但 P2 無法顯示（API 有資料但前端無法渲染）
   - 根本原因：前後端資料結構不一致
     - 前端期望：`additional_data.rows` 陣列（扁平結構）
     - 後端返回：`additional_data.winders` 陣列（巢狀結構）
   - 解決方案：
     - 修改 `_merge_p2_records()` 函數，將資料結構從 `winders` 改為 `rows`
     - 將每個 winder 的 `extras` 直接展開為扁平 dict
     - 確保每個 row 包含 `winder_number` 欄位
   - 修改檔案：`routes_query_v2.py#L174-L230`
   - 測試腳本：`form-analysis-server/test-p2-display.ps1`（待驗證）
   - 技術文件：[dev-docs/2025-01/0113-p2-display-fix.md](../dev-docs/2025-01/0113-p2-display-fix.md)
   - 使用手冊：[dev-docs/USER_GUIDE_ADVANCED_QUERY.md](../dev-docs/USER_GUIDE_ADVANCED_QUERY.md)
   - 影響範圍：低風險，不影響 P1/P3 和 winder 篩選功能
   - 狀態：程式碼修正完成，待整合測試驗證

---

## 0113 發現錯誤/待辦事項（未完成）
- [X] FIX: 在使用一般搜尋時，P1 表格顯示"[object, object]"，未正確解析API(API內已有內容)
- [ ] FIX: p3_records表格未正確關聯 p3_items表格，資料已儲存在items，但是API是讀取records，造成取得空資料的情況
- [ ] FIX: 已v2為準，將legacy的功能平移到v2上，將legacy這個api移除
- [ ] P0：tenant 流程固定化（先求穩定運行）
    - 前端所有 v2 相關呼叫（import/query/traceability）一致帶 X-Tenant-Id，避免靠「唯一 tenant / default tenant」猜測導致資料跑錯租戶。
- [ ] P1：補齊“事件/狀態”可追溯（job 狀態機的 audit）
  - import_jobs 自身的 status 只能看“現在”，但你要的是“發生過什麼事”
  - 先做最小集合：job 建立、validate 完成、commit 開始/成功/失敗（含錯誤摘要、操作者、tenant、時間）
  - DB 已有「所有動作/狀態」表：v2 可以用，但前提是欄位至少能表達 tenant_id / actor / entity_type+id / from_status / to_status / timestamp / payload
- [ ] P2：把“修改紀錄”串起來（edit_reasons / row_edits 的可用性）
    - 先讓 edit_reasons 有“填寫/選擇原因”的寫入 API（不一定要 UI 很漂亮，先可用）
    - 接著在「上傳內容被改」或「匯入前修正」時寫 row_edits（before/after + reason）
- [ ] P3：整理表格責任邊界與清理策略
    - upload_jobs/upload_errors、import_files/staging_rows 的保存/清除規則（例如保留 30/90 天、或成功後只留摘要）避免 staging 爆長導致查詢/備份成本上升
- [ ] FIX: 以"winder_number"為參數搜尋時，會搜尋到P1資料，需要修正錯誤