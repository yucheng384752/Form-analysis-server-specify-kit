## P0（阻斷/明確錯誤，先修）

- [x] ERROR: 生產追溯流程 -> 流程圖 -> P1 原料卡片 -> P1 資料詳情內的"編輯資料"按鈕 422 **需要移除**（前端先移除入口）
  - 已處理：前端已移除 P1 詳情的 edit 入口（避免觸發後端 422）
- [x] ERROR:表格修正功能未正常運作，需要修正（需先確認是哪個頁面/按鈕/功能）
  - 已修（2026-01-09）：UploadPage 若有未儲存的表格修改，點「重新驗證」會改成先呼叫「儲存修改」（PUT /api/upload/{processId}/content，用目前編輯後的 CSV 重新驗證），避免重新上傳原始檔案導致修正無效的錯覺
  - 同步修正文案：錯誤提示/表格提示改為引導按「儲存修改」（會自動重新驗證）

## P1（資料正確性/查詢可信度）

- [x] FIX:P2 分條時間要對應到生產日期
  - 已修（2026-01-09）：P2 詳細表格顯示改用統一格式化（含民國年轉西元）；若「分條時間」只有 HH:MM(/HH:MM:SS) 會自動補上該筆 record.production_date
- [x] ERROR: product_id解析錯誤
  - 已修：P3 trace/detail 不再回傳 UNKNOWN machine/mold（UNKNOWN 時由 extras.rows[0] 推導回傳）
  - 已修：legacy 匯入 + 修復腳本補齊 p3_items.product_id，並處理 UNIQUE 衝突（必要時加 _dup 後綴）
  - 已修：發現某些 _dup 是因「item 的 production_date 被寫成 record 的日期」造成碰撞，已修正匯入邏輯與既有資料（例：20250902_P21_238-3_301_dup9）
- [x] TODO:新資料庫未進行遷移，檔案內容暫時使用舊的record.p2_items以及record.p3_items[需確認]
  - 已確認（2026-01-09）：前端查詢頁目前呼叫 `/api/query/records`、`/api/query/records/advanced`（legacy 路由），因此明細資料來源仍是 `records` + `record.p2_items` / `record.p3_items`
  - 若要改用 V2 正規化查詢（`/api/v2/query/...`、對應 `p1_records/p2_records/p3_records`），需先跑一次 V1→V2 轉換腳本 `backend/migrate_v1_to_v2_internal.py`（或後續全部走 `import_v2` 寫入 V2 表）

## P2（查詢 UX/呈現與可用性）

- [ ] FIX:修改查詢邏輯: 使用高級查詢時，顯示單筆資料即可，有多筆符合，條列之
- [x] FIX:進階搜尋縮小化
  - 已完成（2026-01-12）：進階搜尋按鈕移入搜尋框區塊內，預設收合，點擊展開
- [x] TODO:需確認是否要加入winder Number條件在進階搜尋
  - 已完成（2026-01-12）：進階搜尋已加入 winder_number 篩選條件，支援 P2/P3 資料查詢
- [x] FUNC:新增進階搜尋檢索欄位
  - [x] winder number（已完成 2026-01-12）
  - [x] P1 規格(specification)對應到 P2 的規格(format) P3規格(specification)
    - 已完成（2026-01-12）：統一規格搜尋，後端支援 P1.Specification, P2.format, P3.Specification
  - [ ] material(p1, p2一樣)
- [x] TODO:確認"進階搜尋"的日期起訖是否可以只找當日日期
  - 已完成（2026-01-12）：若只填寫起始或結束日期之一，自動使用同一天進行單日查詢
- [ ] FIX:p2 前端細項表格修正: 將winder number 代替 "#" 欄位
- [x] TODO:p1, p2, p3 基本資料欄位可以移除不顯示
  - 已完成（2026-01-12）：已移除 P1/P2/P3 的「基本資料」卡片區塊
- [x] FUNC:欄位加入排序功能
  - 已完成（2026-01-12）：P2/P3 細項表格支援點擊表頭排序（升序/降序切換）

## P3（新功能/文件/整理）

- [ ] FUNC:PDF 輸入的流程需要詳細記錄
- [ ] TODO:PDFtoCSVserver
  - input: PDF files
  - output: JSON(像是vscode打開csv檔案，只有資料與逗點)
  - PDF file name = CSV file name
- [ ] TODO:Dataframe 格式
  - [ ] 日期篩選
  - [ ] finish 篩選 
- [ ] FUNC:使用簡單加密
- [ ] FILE:撰寫 breakdown 架構圖
- [ ] FILE:撰寫功能表
  - 已實作 source_winder 欄位自動提取邏輯
  - 從 lot_no 最後兩碼提取並儲存到 p3_items.source_winder
  - 支援索引查詢
- [ ] QUES:adjustment record 是否要/有 建立從表?(現在是顯示0, 1 <- 需要詢問是否對應紙本上的A, B, C)
- [ ] TODO:整理冗餘/過時/錯誤資料
- [ ] FUNC:中/英文介面切換

# 0109 已發現的問題/要修正的地方
- [ ] FIX: P1 lot_no 查詢之前端顯示風格修改 -> 需要提供表格(PDFor圖片)
- [ ] FIX: P1 lot_no 查詢之production date欄位解析錯誤(需確認是否為後端輸入資料庫前的解析問題)
- [x] ERROR: Product_id 解析錯誤，需要修正(20250902_Unknown_1_304)
  - 這類 Unknown 來自 DB 欄位 UNKNOWN + 前端組字串；已在後端回傳層做 fallback（從 extras 推導 machine/mold）+ 既有資料回填
- [x] TODO:確認 P3 資料寫入路徑
  - 已確認（2026-01-09）：
    - V2 匯入（import_v2）會寫入 `p3_records`（app/services/import_v2.py 建立/更新 P3Record）
    - legacy 路徑會寫入 `records` + `p3_items`
    - 生產追溯 API `/api/traceability/product/{product_id}` 會先查 `p3_items`，查不到再 fallback 查 `p3_records`
  - 待確認（保留議題）：前端查詢 P3 明細時要「優先哪一路徑」或「合併顯示」的策略（屬 UX/一致性決策）
- [X] FIX: p2_records表有20筆資料，但是p3_records只有一筆資料，需要修復關聯的關係，以及檢查設定檔


## 0112 待辦事項

- [x] 測試 P1 UT API
  - 已完成（2026-01-12）：修復 SQL 類型轉換問題，使用 func.date() 進行日期比較
  - 測試結果：成功返回 1 筆資料 (2026-01)
- [x] 測試 P1+P2+P3 組合查詢
  - 已完成（2026-01-12）：修復追溯邏輯（P3 → P2Record → P2Item → P1Record）
  - 測試結果：成功返回 16 筆資料，欄位前綴正確
- [ ] 修正匯入邏輯（確保未來同步寫入 legacy 和 V2）
- [ ] 查詢P2會顯示20筆，需要修正
- [ ] 是否可以修正成records放單筆資料，細項放在items的表內
- [ ] P1表格顯示錯誤，API未正確取得內容，additional_data是空的
- [ ] product_id產生錯誤，需寫死規定: YYYYMMDD-機台-模號-批號
- [ ] 進階搜尋與查詢按鈕要重新設計(大小相同，寬度與"資料查詢[app-main-tab is-active]"的按鈕相同)
- [ ] 進階查詢要設計展開動畫
- [ ] 