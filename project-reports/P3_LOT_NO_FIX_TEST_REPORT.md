# P3 批號驗證修正 - 最終測試報告

## 🎯 測試目標

驗證新格式 P3 檔案（lot no: 2507173_02_17, 2507173_02_18）能夠：
1. 通過檔案驗證
2. 批號正確正規化為 2507173_02
3. 成功匯入資料庫

## 測試檔案

**檔案名稱：** `P3_0902_P24 copy.csv`

**內容特徵：**
- 資料類型：P3
- 批號格式：7+2+2（如 2507173_02_17, 2507173_02_18）
- 特殊欄位：lot no（非 P3_No.）
- 資料筆數：4 筆

**批號列表：**
```
2507173_02_17 (首筆)
2507173_02_18 (第2-4筆)
```

## 修正內容

### 1. 問題診斷

**原始問題：** 發現 validation.py 中有**兩個**名稱相同的 `normalize_lot_no` 函數

- **第一個函數**（第186-213行）：新版，正確實作
  ```python
  def normalize_lot_no(self, lot_no_value):
      # 使用 LOT_NO_FLEXIBLE_PATTERN
      # 提取前 9 碼（7+2 格式）
      return match.group(1)  # 返回 2507173_02
  ```

- **第二個函數**（第359-383行）：舊版，**錯誤實作**
  ```python
  def normalize_lot_no(self, lot_no_str: str) -> str:
      # 錯誤：把下劃線替換成連字號！
      lot_no_str = lot_no_str.replace('_', '-')
      return lot_no_str  # 返回 2507173-02
  ```

**根本原因：** Python 會使用**最後定義**的函數，因此實際執行的是舊版（錯誤版本），導致批號變成 `2507173-02` 而非 `2507173_02`。

### 2. 修正措施

**刪除舊版 normalize_lot_no 函數**（第359-383行）

```python
# 已刪除這段錯誤的程式碼
def normalize_lot_no(self, lot_no_str: str) -> str:
    """正規化批號 - 移除多餘後綴
    
    處理以下情況：
    1. P1格式：2411012_04 → 2411012-04
    2. P2格式：2412345_03 → 2412345-03
    3. P3格式：2507173_02_17 → 2507173-02 (移除 _17)
    """
    # 錯誤邏輯
    lot_no_str = lot_no_str.replace('_', '-')  # 把下劃線改成連字號
    ...
```

## 測試結果

### 步驟 1: 檔案上傳與驗證

```bash
POST /api/upload
```

**結果：**
```json
{
  "process_id": "d257497b-e87e-4aba-a489-8c0ba1140e4f",
  "total_rows": 4,
  "valid_rows": 4,      全部通過
  "invalid_rows": 0,    無錯誤
  "sample_errors": []
}
```

### 步驟 2: 資料匯入

```bash
POST /api/import
```

**結果：**
```json
{
  "imported_rows": 4,       匯入 4 筆
  "skipped_rows": 0,       無跳過
  "elapsed_ms": 40,
  "message": "資料匯入完成：成功 4 筆，跳過 0 筆",
  "process_id": "d257497b-e87e-4aba-a489-8c0ba1140e4f"
}
```

### 步驟 3: 資料庫驗證

```sql
SELECT lot_no, machine_no, mold_no, production_date, created_at 
FROM records 
WHERE data_type = 'P3' 
ORDER BY created_at DESC 
LIMIT 10;
```

**結果：**
```
 lot_no      | machine_no | mold_no | production_date |          created_at
-------------+------------+---------+-----------------+-------------------------------
 2507173_02  |            |         | 2025-12-15      | 2025-12-15 09:29:08.782431+00  
 2503033_02  |            |         | 2025-11-16      | 2025-11-16 11:57:10.26659+00
 2411012_04  |            |         | 2025-11-16      | 2025-11-16 08:38:29.503818+00
```

**批號正確正規化：** `2507173_02_17` → `2507173_02`

**P3 資料模型驗證：**
```sql
SELECT lot_no, 
       jsonb_array_length(additional_data->'rows') as row_count, 
       production_date 
FROM records 
WHERE lot_no = '2507173_02' AND data_type = 'P3';
```

**結果：**
```
 lot_no      | row_count | production_date 
-------------+-----------+-----------------
 2507173_02  |         4 | 2025-12-15       4 行 CSV 資料
```

**說明：** P3 資料模型將同一批號的多行 CSV 整合為一筆 record，資料儲存在 `additional_data['rows']` JSON 陣列中。這是正確的設計。

## 驗證覆蓋

| 測試項目 | 預期結果 | 實際結果 | 狀態 |
|---------|---------|---------|------|
| 檔案類型檢測 | P3 | P3 | |
| 批號提取（7+2+2 格式） | 2507173_02_17 | 2507173_02_17 | |
| 批號正規化 | 2507173_02 | 2507173_02 | |
| 批號驗證（7+2 格式） | 通過 | 通過 | |
| 資料匯入 | 4 筆 | 4 筆 | |
| 資料庫儲存 | lot_no = 2507173_02 | lot_no = 2507173_02 | |

## 技術細節

### 批號正規化流程

```
原始檔案: lot no = "2507173_02_17"
    ↓
1. 提取批號: "2507173_02_17"
    ↓
2. 正規化 (normalize_lot_no):
   - 使用正規表示式: r'^(\d{7}_\d{2})(?:_.+)?$'
   - 捕獲組 1: "2507173_02"
   - 移除後綴: "_17"
    ↓
3. 驗證格式:
   - 使用正規表示式: r'^\d{7}_\d{2}$'
   - 驗證通過: 
    ↓
4. 儲存到資料庫:
   - lot_no 欄位: "2507173_02"
```

### 正規表示式說明

**彈性模式（正規化）：**
```regex
r'^(\d{7}_\d{2})(?:_.+)?$'
```
- 捕獲前 9 碼（7+2 格式）
- 忽略任意後續內容

**標準模式（驗證）：**
```regex
r'^\d{7}_\d{2}$'
```
- 嚴格匹配 7+2 格式

## 🎯 支援的批號格式

| 輸入格式 | 正規化結果 | 範例 |
|---------|-----------|------|
| 7+2 | 不變 | 2507173_02 → 2507173_02 |
| 7+2+2 | 提取前9碼 | 2507173_02_17 → 2507173_02 |
| 7+2+2+3 | 提取前9碼 | 2411012_04_31_302 → 2411012_04 |
| 7+2+任意 | 提取前9碼 | 2507173_02_xxx → 2507173_02 |

## 修改的檔案

1. **validation.py** - 刪除重複的 normalize_lot_no 函數
   - 保留：第186-213行（正確版本）
   - 刪除：第359-383行（錯誤版本）

2. **Docker 映像** - 重新建置
   ```bash
   docker-compose build --no-cache backend
   docker-compose up -d
   ```

## 已知限制

### Machine NO 和 Mold NO 未對應

**觀察：** 資料庫中 `machine_no` 和 `mold_no` 欄位為空

**原因：** P3 檔案的欄位名稱為 `Machine NO` 和 `Mold NO`（大寫 NO），可能未正確對應到資料庫欄位

**影響：** 低（資料已儲存在 additional_data JSON 欄位中）

**後續處理：** 可選擇性修正欄位對應邏輯

## 部署狀態

- 程式碼修正完成
- Docker 映像已重建
- 系統測試通過
- 資料庫驗證成功

## 📌 總結

**修正前：**
- 批號變成 `2507173-02`（連字號）
- 無法通過 `LOT_NO_PATTERN` 驗證
- 檔案無法匯入

**修正後：**
- 批號正確正規化為 `2507173_02`（下劃線）
- 通過所有驗證
- 資料成功匯入資料庫

---

**測試時間：** 2025年12月15日  
**測試人員：** GitHub Copilot  
**測試狀態：** 全部通過
