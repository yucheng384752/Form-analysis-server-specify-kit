# 表單上傳驗證系統 MVP

**版本**: v1.0  
**建立日期**: 2025-11-08  
**目標**: 建立最小可行的檔案上傳 + 驗證 + 預覽 + 匯入系統

## 1. 概述與目標

### 目標使用者
- **主要使用者**: 內部同仁（負責資料上傳、驗證、匯入作業）
- **次要使用者**: PM/QA（查看處理結果、分析錯誤原因、監控系統狀況）

### 核心價值主張
提供一個直覺、高效的檔案處理系統，讓使用者能快速上傳製造資料或一般 CSV/Excel 檔案，即時獲得驗證結果與錯誤回饋，並能快速修正問題重新匯入。

### 成功衡量指標
- **效率目標**: 90% 的檔案可於第一次上傳內完成「驗證 + 預覽 + 匯入」流程
- **修正速度**: 錯誤回報能讓使用者在 1 分鐘內完成修正並重新上傳
- **系統回應**: 上傳後 3 秒內回傳驗證概要
- **追蹤能力**: 每次操作都可追蹤，便於問題診斷與使用分析

## 2. 功能需求

### 2.1 檔案上傳功能 (US1 - P1)

**使用者故事**: 身為資料管理人員，我要能上傳 CSV 或 Excel 檔案，以便將生產資料匯入系統。

**接受條件**:
- 支援 CSV（UTF-8）和 Excel（.xlsx）格式
- 前端檢查檔案大小上限 10MB，超過時顯示友善錯誤訊息
- 拖拽上傳與點選上傳都支援
- 上傳進度條顯示
- 上傳完成後立即觸發驗證流程

**UI/UX 要求**:
- 清楚的檔案格式說明（支援 CSV, Excel）
- 檔案大小限制提示
- 上傳區域有明顯的視覺回饋（hover、drop zone）
- 錯誤狀態下提供重試選項

### 2.2 即時驗證與預覽 (US2 - P1)

**使用者故事**: 身為資料管理人員，我要能立即看到上傳檔案的驗證結果和資料預覽，以便決定是否進行匯入。

**驗證規則**:

**欄位結構驗證**:
- 必需欄位: `lot_no`, `product_name`, `quantity`, `production_date`
- 如缺少必需欄位或有未知欄位，直接阻擋匯入並明確回報
- 回傳支援的欄位清單供參考

**資料型別與格式驗證**:
- `lot_no`: 符合「7位數字_2位數字」模式（如：1234567_01）
- `quantity`: 非負整數（>= 0）
- `production_date`: YYYY-MM-DD 格式的有效日期
- `product_name`: 非空白字串，長度 1-100 字元

**列級錯誤記錄**:
```json
{
  "row_index": 3,
  "field": "quantity", 
  "error_code": "INVALID_TYPE",
  "message": "數量必須為非負整數，當前值：-5"
}
```

**接受條件**:
- 3 秒內回傳驗證概要（總筆數、錯誤筆數、可匯入筆數）
- 預覽顯示前 10-20 筆可匯入的資料
- 錯誤清單顯示所有問題，包含列號、欄位、具體錯誤訊息
- 錯誤可依類型篩選與排序
- 提供「下載錯誤列 CSV」功能

### 2.3 確認匯入功能 (US3 - P1)

**使用者故事**: 身為資料管理人員，確認預覽結果正確後，我要能執行匯入操作，並獲得詳細的處理結果。

**接受條件**:
- 匯入前再次確認：顯示將匯入的筆數與跳過的筆數
- 匯入過程顯示進度（如果處理時間超過 5 秒）
- 匯入完成後顯示結果摘要：
  - 成功匯入筆數
  - 跳過筆數（含原因）
  - 失敗筆數（含錯誤原因）
- 生成唯一的 `process_id` 供後續查詢追蹤
- 提供「下載處理報告」功能（包含所有錯誤與警告）

### 2.4 錯誤處理與用戶體驗 (US4 - P2)

**使用者故事**: 身為資料管理人員，當發生錯誤時，我要能快速理解問題並知道如何修正。

**友善錯誤訊息**:
- 使用中文，避免技術術語
- 提供具體的修正建議
- 錯誤訊息可複製到剪貼板
- 常見錯誤提供 FAQ 連結

**錯誤分類與優先級**:
- **阻擋性錯誤**: 欄位結構問題、檔案格式錯誤
- **列級錯誤**: 資料格式、型別、範圍問題
- **警告**: 資料品質問題但不阻擋匯入

### 2.5 操作追蹤與日誌 (US5 - P3)

**使用者故事**: 身為系統管理員，我要能追蹤每次操作的詳細記錄，以便問題診斷和使用分析。

**追蹤要求**:
- 每次匯入產生唯一 `process_id`
- 記錄：使用者 ID、來源 IP、操作時間、檔案名稱、處理耗時
- 記錄驗證結果、匯入結果、錯誤統計
- 支援按 process_id、使用者、時間範圍查詢操作歷史

## 3. 非功能性需求

### 3.1 效能需求
- **上傳回應**: 檔案上傳完成後 3 秒內回傳驗證概要
- **檔案處理**: 支援最大 10MB 檔案，約 50,000 列資料
- **並發處理**: 支援同時 10 個使用者上傳操作
- **資料庫寫入**: 匯入操作在 30 秒內完成（對於 10,000 筆資料）

### 3.2 可用性需求
- **直覺介面**: 新使用者無需訓練即可完成基本操作
- **錯誤回復**: 所有錯誤狀態都有明確的下一步指引
- **進度透明**: 長時間操作提供進度指示
- **行動支援**: 基本功能支援平板設備使用

### 3.3 可靠性需求
- **資料完整性**: 匯入操作具備交易特性（全部成功或全部回滾）
- **錯誤恢復**: 系統異常時能保留使用者的處理進度
- **追蹤能力**: 所有操作都有審計日誌可供查詢

### 3.4 安全性需求
- **檔案驗證**: 上傳檔案的格式與內容驗證
- **輸入清理**: 防止 CSV 注入攻擊
- **存取控制**: 操作記錄包含使用者身份
- **資料隱私**: 敏感資料不出現在日誌中

## 4. 技術約束

### 4.1 支援的檔案格式
- CSV: UTF-8 編碼，支援 BOM
- Excel: .xlsx 格式（不支援 .xls）
- 檔案大小: 最大 10MB

### 4.2 瀏覽器相容性
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### 4.3 整合需求
- 與現有使用者認證系統整合
- 資料寫入主要業務資料庫
- 支援 API 方式整合其他系統

## 5. 使用者介面規格

### 5.1 主要頁面流程
```
[上傳頁面] → [驗證結果頁面] → [確認匯入頁面] → [完成頁面]
     ↓              ↓                ↓             ↓
   檔案選擇      預覽+錯誤列表     匯入確認        結果摘要
```

### 5.2 關鍵 UI 元件
- **上傳區域**: 拖拽式檔案選擇器
- **驗證結果卡片**: 概要統計（總筆數、錯誤筆數、可匯入筆數）
- **資料預覽表格**: 可匯入資料的前 N 筆預覽
- **錯誤清單**: 可篩選、可排序的錯誤列表
- **操作按鈕**: 下載錯誤 CSV、確認匯入、重新上傳

### 5.3 響應式設計
- 桌面優先，支援平板使用
- 表格在小螢幕上水平滾動
- 關鍵操作按鈕在各螢幕尺寸下都易於點擊

## 6. API 規格概要

### 6.1 核心端點
- `POST /api/upload/validate` - 檔案上傳與驗證
- `GET /api/upload/{process_id}/result` - 獲取詳細驗證結果
- `POST /api/upload/{process_id}/import` - 確認匯入
- `GET /api/upload/{process_id}/errors.csv` - 下載錯誤 CSV
- `GET /api/upload/history` - 查詢操作歷史

### 6.2 回應格式
```json
{
  "process_id": "uuid-v4",
  "status": "validated|imported|failed",
  "summary": {
    "total_rows": 1000,
    "valid_rows": 980,
    "error_rows": 20
  },
  "errors": [...],
  "preview_data": [...]
}
```

## 7. 測試策略

### 7.1 測試範圍
- **檔案格式測試**: 各種 CSV/Excel 格式相容性
- **資料驗證測試**: 所有驗證規則的正向與負向測試
- **效能測試**: 大檔案處理與並發使用者測試
- **使用者體驗測試**: 實際使用情境的端到端測試

### 7.2 測試資料
- 標準格式檔案（小、中、大尺寸）
- 各種錯誤情況的測試檔案
- 邊界條件測試資料（空檔案、單列檔案、最大檔案）

## 8. 部署與維運

### 8.1 部署要求
- Docker 容器化部署
- 支援水平擴展（多個處理節點）
- 健康檢查端點提供

### 8.2 監控指標
- 上傳檔案數量與大小統計
- 驗證錯誤類型分布
- 匯入成功率與處理時間
- 系統資源使用情況

### 8.3 維運工具
- 操作日誌查詢介面
- 錯誤統計儀表板
- 系統健康狀態監控

## 9. 風險與限制

### 9.1 已知限制
- 檔案大小限制 10MB
- 不支援複雜的 Excel 功能（公式、巨集、多工作表）
- 暫不支援即時協作編輯

### 9.2 技術風險
- 大檔案處理可能影響系統回應
- Excel 檔案解析相容性問題
- 並發處理時的資源競爭

### 9.3 緩解策略
- 實施檔案大小與處理時間監控
- 提供詳細的相容性說明文件
- 設計優雅的降級機制

## 10. 未來規劃

### 10.1 後續版本功能
- 批次處理多個檔案
- 資料轉換與清理規則配置
- 匯入模板管理
- 進階資料驗證規則

### 10.2 整合擴展
- 與 ERP 系統深度整合
- 支援更多資料格式（JSON、XML）
- API 開放給第三方系統使用
- 行動應用程式支援

---

**文件狀態**: 初版完成，待技術評審  
**下一步**: 建立技術實作計畫與原型開發