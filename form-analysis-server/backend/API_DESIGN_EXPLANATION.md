# API 設計說明文件

##  設計原則和決策理由

### 1. 為什麼以 `lot_no` 作為唯一鍵？

**資料分析發現：**
- P1 檔案：`P1_2503033_01.csv` → lot_no = `2503033_01`
- P2 檔案：`P2_2503033_03.csv` → lot_no = `2503033_03`  
- P3 檔案：`P3_0210_P02.csv` → lot_no = `0210???` (需要從P3_No.欄位提取)

**設計決策：**
```sql
lot_no VARCHAR(20) PRIMARY KEY  -- 格式：7位數字_2位數字 (如 2503033_01)
```

**理由：**
1. **業務邏輯自然性**：lot_no 是生產流程的核心標識符，從 P1 到 P3 都圍繞此編號
2. **跨階段追溯**：同一批次在不同階段可以通過 lot_no 關聯所有數據
3. **檔案命名一致性**：現有檔案命名已包含 lot_no 資訊
4. **查詢效能**：直接使用業務主鍵，避免不必要的 JOIN 操作

### 2. 資料庫架構設計理由

####  **分階段表設計**
```
production_lots (主表)
├── p1_extrusion_data (P1階段)
├── p2_quality_data (P2階段)  
├── p3_inspection_data (P3階段)
├── quality_measurements (品質測量)
└── defect_records (不良品記錄)
```

**理由：**
- **資料隔離**：不同階段數據結構差異很大，分表管理更清晰
- **效能優化**：避免單表過寬，提升查詢效能
- **擴展性**：未來新增階段或修改結構更靈活
- **維護性**：各階段可獨立備份和維護

####  **外鍵關聯設計**
```sql
REFERENCES production_lots(lot_no) ON DELETE CASCADE
```
**理由：**
- **數據一致性**：確保子表記錄必須對應有效的生產批次
- **級聯刪除**：刪除批次時自動清理所有相關數據
- **參照完整性**：防止孤兒記錄產生

### 3. API 設計模式理由

####  **RESTful 資源導向**
```
GET    /api/production/lots/{lot_no}           # 獲取批次詳情
POST   /api/data/p1/{lot_no}                   # 新增P1數據
PUT    /api/data/p1/{lot_no}/{record_id}      # 更新P1記錄
DELETE /api/data/p1/{lot_no}/{record_id}      # 刪除P1記錄
```

**理由：**
1. **直觀性**：URL 結構直接反映資源層級關係
2. **一致性**：所有操作遵循相同的命名模式
3. **可預測性**：開發者可以猜測API端點結構
4. **標準化**：遵循HTTP動詞語義

####  **以 lot_no 為路徑參數的理由**
```python
@router.get("/p1/{lot_no}")  #  推薦
# vs
@router.get("/p1?lot_no={lot_no}")  #  不推薦
```

**理由：**
- **語義明確**：lot_no 是資源的主要標識符，應該在路徑中體現
- **SEO友善**：路徑參數有利於API文檔生成和搜索
- **緩存效率**：路徑參數更容易被CDN和代理服務器緩存
- **安全性**：路徑參數不會出現在查詢字串日誌中

### 4. 數據模型設計理由

####  **Pydantic 模型層次**
```python
ProductionLotBase      # 基礎欄位
├── ProductionLotCreate    # 創建請求 (繼承全部)
├── ProductionLotUpdate    # 更新請求 (全部可選)
└── ProductionLotResponse  # 響應模型 (添加計算欄位)
```

**理由：**
1. **代碼重用**：避免重複定義相同欄位
2. **類型安全**：編譯時捕獲數據類型錯誤
3. **自動驗證**：請求數據自動驗證格式和約束
4. **文檔生成**：自動生成API文檔和OpenAPI規範

#### 🔢 **數據類型選擇理由**
```python
actual_temps: List[Optional[float]]  # 溫度陣列
quality_rate: float                  # 計算欄位
lot_no: str = Field(..., pattern=r'^\d{7}_\d{2}$')  # 格式驗證
```

**理由：**
- **精確性**：使用 DECIMAL 避免浮點數精度問題
- **靈活性**：Optional 允許部分數據缺失
- **驗證性**：正則表達式確保數據格式正確
- **效能性**：陣列結構適合大量數值數據

### 5. 批量上傳設計理由

####  **檔案類型路由**
```python
@upload_router.post("/csv/{phase}/{lot_no}")
@upload_router.post("/json/{lot_no}")
```

**理由：**
1. **類型明確**：路徑直接指明處理的檔案類型和階段
2. **處理分離**：不同類型檔案使用不同的解析邏輯
3. **錯誤隔離**：某種檔案格式錯誤不影響其他類型
4. **效能優化**：可針對不同檔案類型優化處理流程

### 6. 查詢和分析API理由

####  **分層查詢設計**
```
/api/production/lots        # 基本列表查詢
/api/analytics/search       # 全文搜尋
/api/analytics/filter/advanced  # 高級篩選
```

**理由：**
1. **功能分離**：不同複雜度的查詢使用不同端點
2. **效能分級**：簡單查詢快速回應，複雜查詢專門優化
3. **擴展性**：未來可獨立優化各種查詢類型
4. **用戶體驗**：前端可根據場景選擇合適的查詢方式

##  實施優勢

### 1. 開發優勢
- **型別安全**：Pydantic 模型提供完整的類型檢查
- **自動文檔**：FastAPI 自動生成 OpenAPI 文檔
- **測試友善**：清晰的模型結構便於編寫測試
- **IDE支援**：完整的類型提示和自動補全

### 2. 維護優勢  
- **數據一致性**：外鍵約束確保數據完整性
- **架構清晰**：分層設計便於理解和修改
- **錯誤追蹤**：結構化錯誤模型便於除錯
- **版本控制**：資料庫遷移支援版本管理

### 3. 效能優勢
- **索引優化**：針對常用查詢建立索引
- **查詢分離**：讀寫分離的API設計
- **批量操作**：支援大量數據的批次處理
- **緩存友善**：RESTful設計便於結果緩存

### 4. 擴展優勢
- **階段擴展**：輕鬆新增 P4, P5 等新階段
- **欄位擴展**：可選欄位設計支援逐步增加功能
- **API版本**：路由設計支援多版本並存
- **微服務**：模組化設計便於拆分成微服務

##  使用範例

### 完整工作流程：
```python
# 1. 創建批次
POST /api/production/lots
{
    "lot_no": "2503033_01",
    "production_date": "2025-03-03",
    "phase": "P1"
}

# 2. 上傳P1數據
POST /api/upload/csv/P1/2503033_01
[CSV檔案]

# 3. 查詢完整資料
GET /api/production/lots/2503033_01

# 4. 分析趨勢
GET /api/analytics/trends/2503033_01
```

這個設計充分利用了 lot_no 作為核心標識符的優勢，提供了完整、高效、可擴展的生產數據管理系統。